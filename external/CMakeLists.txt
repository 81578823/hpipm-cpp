include(FetchContent)
include(ExternalProject)

# build blasfeo
set(BLASFEO_SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/blasfeo)
set(BLASFEO_DEST_DIR ${CMAKE_CURRENT_SOURCE_DIR}/blasfeo_install)
set(BLASFEO_HEADERS_INSTALLATION_DIRECTORY ${PROJECT_SOURCE_DIR}/include/hpipm-cpp/blasfeo)

FetchContent_GetProperties(blasfeo)
if(NOT inekf_POPULATED)
  FetchContent_Populate(
    blasfeo
    GIT_REPOSITORY https://github.com/giaf/blasfeo.git 
    GIT_TAG        master
    GIT_SHALLOW    TRUE
    SOURCE_DIR ${BLASFEO_SRC_DIR})
endif()
ExternalProject_Add(
  blasfeo
  SOURCE_DIR ${BLASFEO_SRC_DIR}
  BUILD_IN_SOURCE TRUE
  INSTALL_DIR ${BLASFEO_DEST_DIR}
  CONFIGURE_COMMAND ${CMAKE_COMMAND} -DCMAKE_INSTALL_PREFIX=${BLASFEO_DEST_DIR} -DBLASFEO_HEADERS_INSTALLATION_DIRECTORY=${BLASFEO_HEADERS_INSTALLATION_DIRECTORY} -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBUILD_SHARED_LIBS=ON -DBLASFEO_EXAMPLES=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DLA=HIGH_PERFORMANCE 
)

# build hpipm
set(HPIPM_SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/hpipm)
set(HPIPM_DEST_DIR ${CMAKE_CURRENT_SOURCE_DIR}/hpipm_install)
set(HPIPM_HEADERS_INSTALLATION_DIRECTORY ${PROJECT_SOURCE_DIR}/include/hpipm-cpp/hpipm)

FetchContent_GetProperties(hpipm)
if(NOT inekf_POPULATED)
  FetchContent_Populate(
    hpipm
    GIT_REPOSITORY https://github.com/giaf/hpipm.git 
    GIT_TAG        master
    GIT_SHALLOW    TRUE
    SOURCE_DIR ${HPIPM_SRC_DIR})
endif()
ExternalProject_Add(
  hpipm
  SOURCE_DIR ${HPIPM_SRC_DIR}
  BUILD_IN_SOURCE TRUE
  INSTALL_DIR ${HPIPM_DEST_DIR}
  CONFIGURE_COMMAND ${CMAKE_COMMAND} -DCMAKE_INSTALL_PREFIX=${HPIPM_DEST_DIR} -DHPIPM_HEADERS_INSTALLATION_DIRECTORY=${HPIPM_HEADERS_INSTALLATION_DIRECTORY} -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBUILD_SHARED_LIBS=ON -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DBLASFEO_PATH=${BLASFEO_DEST_DIR} -DBLASFEO_INCLUDE_DIR=${BLASFEO_HEADERS_INSTALLATION_DIRECTORY} 
)
add_dependencies(hpipm blasfeo)